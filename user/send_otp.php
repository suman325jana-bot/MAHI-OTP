<?php require_once __DIR__ . '/../core/db.php'; header('Content-Type: application/json'); $db = db(); $mobile = trim($_POST['mobile'] ?? ''); $purpose = trim($_POST['purpose'] ?? 'login'); if(!$mobile){ echo json_encode(['ok'=>false,'msg'=>'Mobile required']); exit; } $otp = rand(100000,999999); $otp_hash = password_hash($otp, PASSWORD_DEFAULT); $expires = date('Y-m-d H:i:s', time()+300); $stmt = $db->prepare("INSERT INTO otp_requests (mobile,otp_hash,purpose,expires_at) VALUES (?,?,?,?)"); $stmt->bind_param('ssss',$mobile,$otp_hash,$purpose,$expires); $stmt->execute(); $provider = defined('OTP_MODE')?OTP_MODE:'manual'; $sent=false; if($provider==='manual'){ $show = true; } else { $show=false; /* provider sending code here */ } echo json_encode(['ok'=>true,'show_otp'=>$show,'otp'=>$show?$otp:null]); ?>