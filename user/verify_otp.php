<?php require_once __DIR__ . '/../core/db.php'; header('Content-Type: application/json'); $db = db(); $mobile=trim($_POST['mobile']??''); $otp=trim($_POST['otp']??''); $purpose=trim($_POST['purpose']??'login'); if(!$mobile||!$otp){ echo json_encode(['ok'=>false,'msg'=>'mobile+otp required']); exit; } $stmt = $db->prepare("SELECT id, otp_hash, expires_at, used FROM otp_requests WHERE mobile=? AND purpose=? ORDER BY id DESC LIMIT 1"); $stmt->bind_param('ss',$mobile,$purpose); $stmt->execute(); $res=$stmt->get_result(); if(!$res||!$res->num_rows){ echo json_encode(['ok'=>false,'msg'=>'no request']); exit; } $r=$res->fetch_assoc(); if($r['used']){ echo json_encode(['ok'=>false,'msg'=>'already used']); exit; } if(strtotime($r['expires_at'])<time()){ echo json_encode(['ok'=>false,'msg'=>'expired']); exit; } if(password_verify($otp,$r['otp_hash'])){ $id=(int)$r['id']; $db->query("UPDATE otp_requests SET used=1 WHERE id=$id"); echo json_encode(['ok'=>true,'msg'=>'verified']); } else { echo json_encode(['ok'=>false,'msg'=>'invalid']); } ?>